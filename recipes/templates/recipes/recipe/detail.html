{% load static %}
{% load humanizelib %}
{% load tz %}

<link rel="stylesheet" href="{% static 'base/style.css' %}">
<link rel="stylesheet" href="{% static 'recipes/recipe_detail.css' %}">

<body>

  <div class="recipe-grid">
    <div class="recipe-grid__body">
      {% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}

      <div class="title-image-grid">
        <div class="title-image_grid__text">
          <div class="recipe-title">
            <h1>{{ recipe.title }}</h1>
          </div>

          {# is there is no intro, put title image in grid with just tite #}
          {#TODO: handle every combination of intro & prep. #}
          {% if not has_intro %}
            {% include "../partials/recipe_image.html" with has_intro=False has_prep=recipe.has_prep %}
          {% endif %}

          {% if has_intro %}
            <div class="introduction-variations">
              {% if recipe.introduction is not None %}
                <p> {{ recipe.introduction }} </p>
              {% endif %}
              {% if recipe.variations is not None %}
                <p> <i>Variations.</i> {{  recipe.variations }} </p>
              {% endif %}
            </div>
          {% endif %}
        </div>

        {# This (?) exists outside the title image grid IFF a recipe intro is present. #}
        {% if  has_intro %}
          {% include "../partials/recipe_image.html" with has_intro=True %}
        {% endif %}

      </div>

      {% if has_prep %}
        <div class="prep-cook-time">
          {% if recipe.prep_time is not None %}
            Prep time: {{ recipe.prep_time }}
          {% endif %}
          {% if recipe.prep_time is not None and recipe.cook_time is not None %}
            |
          {% endif %}
          {% if recipe.cook_time is not None %}
            Cook time: {{  recipe.cook_time }}
          {% endif %}
        </div>
      {% endif %}


      {% if has_ingredients or has_directions %}

        <div class="ingredients-directions-container">
          {% if has_ingredients %}
            <div class="ingredients">
              <h3 class="ingredients-directions-header"> Ingredients </h3>
              {% if has_servings %}
                <p class = "servings">
                <i>Serves {{  recipe.servings|fractional }}</i>
                </p>
              {% endif %}
              {% if has_makes %}
                <p class = "makes">
                {% if recipe.recipeservingunit_set.all is not None %}
                  {% for rsu in recipe.recipeservingunit_set.all %}
                    <i>Makes
                      {# TODO: make this a partial #}
                      {# #### Format serving units strings #### #}
                      {# (1) Format numbers #}
                      {# ##      if greater than one, round to one decimal. #}
                      {# ##      if whole number, remove trailing zeroes #}
                      {# ##      if less than 1, display as fraction #}
                      {% if rsu.amount is not None %}
                        {{ rsu.amount|fractional|default_if_none:"" }}
                        {# (2) Pluralize units, if they exist #}
                        {# ##  Manually specify any units that should be pluralized #}
                        {# ##      if "cup", pluralize depending on "amount" #}
                        {% if rsu.unit == "cup" %}
                          cup{{ rsu.amount|pluralize:'s' }}
                        {% else %}
                          {{ rsu.unit|default_if_none:"" }}
                        {% endif %}
                        {# If there is a unit, add "of" #}
                        {% if rsu.unit is not None %}
                          of
                        {% endif %}
                      {% endif %}
                      {# (3) Pluralize ingredient name, if no units, depending on "amount" #}
                      {# (3a) If there is no unit, don't pluralize ingredient name. #}
                      {% if rsu.unit is None %}
                        {{ rsu.servingunit_id }}{{ rsu.amount|pluralize }}
                      {% else %}
                        {{ rsu.servingunit_id }}
                      {% endif %}
                    </i>
                  {% endfor %}
                {% endif %}
                </p>
              {% endif %}
              <ul class="ingredients-list">
                {% if recipe.recipeingredient_set.all is not None %}
                  {% for ri in recipe.recipeingredient_set.all %}
                    <li>
                      {# #### Format recipe ingredient strings #### #}
                      {# (1) Format numbers #}
                      {# ##      if greater than one, round to one decimal. #}
                      {# ##      if whole number, remove trailing zeroes #}
                      {# ##      if less than 1, display as fraction #}
                      {% if ri.amount is not None %}
                        {{ ri.amount|fractional|default_if_none:"" }}
                        {# (2) Pluralize units, if they exist #}
                        {# ##  Manually specify any units that should be pluralized #}
                        {# ##      if "cup", pluralize depending on "amount" #}

                        {% if ri.unit == "cup" %}
                          cup{{ ri.amount|pluralize:'s' }}
                        {% else %}
                          {{ ri.unit|default_if_none:"" }}
                        {% endif %}
                        {# If there is a unit, add "of" #}
                        {% if ri.unit is not None %}
                          of
                        {% endif %}

                      {% endif %}
                      {# (3) Pluralize ingredient name, if no units, depending on "amount" #}
                      {# (3a) If there is no unit, don't pluralize ingredient name. #}
                      {% if ri.unit is None %}
                        <strong>{{ ri.ingredient_id }}{{ ri.amount|pluralize }}</strong>
                      {% else %}
                        <strong>{{ ri.ingredient_id }}</strong>
                      {% endif %}
                      {# (3b) If there is a unit, pluralize it. #}
                      {% if ri.description is not None %}
                        ({{ ri.description }})
                      {% endif %}
                    </li>
                  {% endfor %}
                {% endif %}
              </ul>
            </div>
          {% endif %}
          {% if has_ingredients and has_directions %}
            <div class="ingredients-directions-separator">
            </div>
          {%endif %}
          {% if has_directions %}
            <div class="directions">
              <h3 class="ingredients-directions-header"> Directions </h3>
              {{ recipe.instructions|linebreaks }}
            </div>
          {% endif %}
        </div>

      {% endif %}

      {% if has_tags %}
        <div class="tags">
          {% for tag in recipe.tags.all %}
            <a href="{% url 'recipes:tag_detail' tag.id %}">{{ tag.name }}</a>
            {% if not forloop.last %}|{% endif %}
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <div class="recipe-grid__footer">
      {# TODO: Ask Josh - what is the simplest, best way to add an element like this navbar, with a paragraph spave after it? #}
      <p>
      <em>
        {% timezone "US/Eastern" %}
          {# Show date last updated, if different from date created #}
          {% if recipe.created_at|date == recipe.updated_at|date %}
            Published by {{ author_label }} {{ recipe.created_at.date }}
          {% else %}
            Published by {{ author_label }} {{ recipe.created_at|date:"F j, o" }}
            | Updated {{ recipe.updated_at|date:"F j, o" }} {{ recipe.updated_at|time:"P" }}
          {% endif %}
      </em>
      <br>
      {% include "../partials/navbar_footer.html" %}
    {% endtimezone %}
      </p>
    </div>

  </div>

</body>
